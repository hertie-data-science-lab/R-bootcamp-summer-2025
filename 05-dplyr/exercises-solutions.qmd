---
title: dplyr Row Exercises
---

```{r}
library(tidyverse)
```

## Row Level Exercises (`filter()`, `distinct()`, and `count()`)

```{r}
if (!("nycflights13" %in% installed.packages())) {
  install.packages("nycflights13")
}
library(nycflights13)
flights <- flights
```

For these exercises, we will use the dataframe `flights` from the `nycflights13` package, which has one row per flight that departed from New York City in 2013 (336776 rows).

These exercises come from (or were adapted from) [R for Data Science](https://r4ds.hadley.nz/data-transform.html#exercises).

1. Was there a flight on every day in 2013?

```{r}
flights |>
  distinct(day, month) %>%
  count()
```


2. Find all flights that arrived more than two hours late but didnâ€™t leave late.

```{r}
flights |>
  filter(dep_delay <= 0) |>
  filter(arr_delay >= 120)
```

3. Find all destinations that had at least one flight with a flight time of 12 hours or more.

```{r}
flights |>
  filter(air_time >= 600) |>
  distinct(dest)
```

4. Find all flights in the summer (June, July, August) that arrived on time.

```{r}
flights |>
  filter(month >= 6, month <= 8) |>
  filter(arr_delay <= 0)
```

## Success of Leader Assassination as a Natural Experiment

```{r}
leaders <- read_csv("data/leaders.csv")

leaders
```

Source: Chapter 2 of [Quantiative Social Science: An Introduction with Tidyverse](https://press.princeton.edu/books/paperback/9780691222288/quantitative-social-science) with modifications by [Jackson Luckey](www.jacksonmluckey.com) to shift the emphasis towards data science and away from causal inference and to include more opportunities to make plots and summary tables.

One longstanding debate in the study of international relations concerns the question of whether individual political leaders can make a difference. Some emphasize that leaders with different ideologies and personalities can significantly affect the course of a nation. Others argue that political leaders are severely constrained by historical and institutional forces. Did individuals like Hitler, Mao, Roosevelt, and Churchill make a big difference? The difficulty of empirically testing these arguments stems from the fact that the change of leadership is not random and there are many confounding factors to be adjusted.

| Variable         | Description                                                                 |
|------------------|-----------------------------------------------------------------------------|
| `country`        | Country                                                                     |
| `year`           | Year                                                                        |
| `leadername`     | Name of leader who was targeted                                             |
| `age`            | Age of the targeted leader                                                 |
| `politybefore`   | Average polity score during the three-year period prior to the attempt      |
| `polityafter`    | Average polity score during the three-year period after the attempt         |
| `civilwarbefore` | 1 if the country was in civil war during the three-year period prior to the attempt, 0 otherwise |
| `civilwarafter`  | 1 if the country was in civil war during the three-year period after the attempt, 0 otherwise  |
| `interwarbefore` | 1 if the country was in international war during the three-year period prior to the attempt, 0 otherwise |
| `interwarafter`  | 1 if the country was in international war during the three-year period after the attempt, 0 otherwise  |
| `result`         | Result of the assassination attempt                                         |

In this exercise we consider a natural experiment in which the success or failure of assassination attempts is assumed to be essentially random. Each observation of the CSV data set `leaders.csv` contains information about an assassination attempt. The table above presents the names and descriptions of variables in this leader assassination data set.

The polity variable represents the so-called polity score from the Polity Project. The Polity Project systematically documents and quantifies the regime types of all countries in the world from the year 1800. The polity score is a 21-point scale ranging from - 10 (hereditary nonarchy) to 10 (consolidated democracy). The `result` variable is a 10-category factor variable describing the result of each assassination attempt.

1. How many assassination attempts are recorded in the data?

```{r}
leaders |>
  count()
```


2. How many countries experienced at least one leader assassination attempt?

```{r}
leaders |>
  count(country)
```

3. Among countries with at least one leader assassination attempt, what is the average number of attempts per year?

```{r}
leaders |>
  summarise(n_countries = n_distinct(country),
            n_attempts = n(),
            first_year = min(year),
            last_year = max(year)) |>
  mutate(n_years_in_data = last_year - first_year) |>
  mutate(attempts_per_year = n_attempts / n_years_in_data) |>
  mutate(attempts_per_year_per_country = attempts_per_year / n_countries) |>
  select(attempts_per_year_per_country)
```

4. Create a new variable called `success` that is equal to 1 if a leader dies from the attack at any point and 0 if the leader survives (you'll need to look at the possible values for the `result` variable).

Hint: You can use `%in%` to see if a value is in a vector. For example,

```{r}
leaders |>
  mutate(country_starts_with_A = country %in% c("Afghanistan", "Albania", "Algeria", "Argentina", "Australia", "Austria")) |>
  distinct(country, country_starts_with_A)
```

```{r}
leaders |>
  distinct(result)
```

```{r}
leaders <- leaders |>
  mutate(success = result %in% c("dies within a day after the attack", "dies between a day and a week", "dies, timing unknown", "dies between a week and a month"))
```

5. What is the overall success rate of leader assassination?

```{r}
leaders |>
  summarise(attempts = n(),
            successes = sum(success)) |>
  mutate(success_rate = successes / attempts)
```

6. Is there any difference in the age of targeted leaders between successful and failed attempts? You can use `summarise()`, make plot(s) with `ggplot()`, or both.

```{r}
leaders |>
  group_by(success) %>%
  summarise(n = n(),
            min_age = min(age),
            mean_age = mean(age),
            median_age = median(age),
            max_age = max(age))
```

```{r}
ggplot(leaders, aes(x = age, fill = success)) +
  geom_density(alpha = 0.5)
```

```{r}
ggplot(leaders, aes(x = age, fill = success)) +
  geom_histogram(alpha = 0.5)
```

Optional causal inference: Does the data support the assumption that the success of assassination attempts is randomly determined?

7. Does the average polity score over three years prior to an assassination attempt differ on average between successful and failed attempts?

```{r}
leaders |>
  group_by(success) |>
  summarise(n = n(),
            min_politybefore = min(politybefore),
            mean_politybefore = mean(politybefore),
            median_politybefore = median(politybefore),
            max_politybefore = max(politybefore))
```

```{r}
ggplot(leaders, aes(x = politybefore, fill = success)) +
  geom_density(alpha = 0.5)
```

```{r}
ggplot(leaders, aes(x = politybefore, fill = success)) +
  geom_histogram(alpha = 0.5)
```

Optional causal inference: Do you find it plausible that this is a causal effect? Why?

8. Create a new variable called `warbefore` that is 1 if a country is in civil or international war in the three years before the assassination attempt and 0 otherwise.

Hint: You can use the OR operator (`|`).

```{r}
leaders <- leaders |>
  mutate(warbefore = interwarbefore | civilwarbefore)
```

```{r}
leaders <- leaders |>
  mutate(warbefore = (interwarbefore + civilwarbefore) > 0)
```

9. Compare the success rate of assassinations between cases where the country is in civil or international war in the three years before the assassination attempt and cases where it is not.

```{r}
leaders |>
  group_by(warbefore) |>
  summarise(n = n(),
            successes = sum(success)) %>%
  mutate(success_rate = successes / n)
```

Optional causal inference: Reconsider whether the data supports the assumption that the success of assassination attempts is randomly determined.

10. Create a new variable called `warafter` that is 1 if a country is in civil or international war in the three years after the assassination attempt and 0 otherwise.

```{r}
leaders <- leaders |>
  mutate(warafter = interwarafter | civilwarafter)
```

```{r}
leaders <- leaders |>
  mutate(warafter = (interwarafter + civilwarafter) > 0)
```

11. Calculate the rate of civil war, international war, and any kind of war after the assassination attempt between cases with and without successful assassinations.

```{r}
leaders |>
  group_by(success) |>
  summarise(n = n(),
            civil_war = sum(civilwarafter) / n,
            international_war = sum(interwarafter) / n,
            any_war = sum(warafter) / n)
```